"""
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ aimetodolog.
–í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∑–¥–µ—Å—å.
–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Google Colab –∏ –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.
"""

import os
import sys
from pathlib import Path

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã –≤ Google Colab
IN_COLAB = 'COLAB_GPU' in os.environ

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env —Ñ–∞–π–ª–∞, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
try:
    from dotenv import load_dotenv
    env_path = Path(__file__).parent / '.env'
    if env_path.exists():
        load_dotenv(env_path)
        print(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env —Ñ–∞–π–ª–∞")
    else:
        print(f"‚ö†Ô∏è  –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –ø—É—Ç–∏: {env_path}")
except ImportError:
    print("‚ö†Ô∏è  python-dotenv –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ .env –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã")

from platform_utils import get_secret

# ============================================================================
# 1. –ù–ê–°–¢–†–û–ô–ö–ò API –ò –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ô
# ============================================================================

# –ü–æ–ª—É—á–∞–µ–º API –∫–ª—é—á OpenRouter —á–µ—Ä–µ–∑ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ-–Ω–µ–∑–∞–≤–∏—Å–∏–º—É—é —Ñ—É–Ω–∫—Ü–∏—é
OPENROUTER_API_KEY = get_secret("OPENROUTER_API_KEY")

if OPENROUTER_API_KEY:
    if IN_COLAB:
        print(f"‚úÖ API –∫–ª—é—á OpenRouter –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤ Colab ({len(OPENROUTER_API_KEY)} —Å–∏–º–≤–æ–ª–æ–≤)")
    else:
        print(f"‚úÖ API –∫–ª—é—á OpenRouter –≤–∑—è—Ç –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è ({len(OPENROUTER_API_KEY)} —Å–∏–º–≤–æ–ª–æ–≤)")
else:
    OPENROUTER_API_KEY = None
    print("‚ö†Ô∏è  API –∫–ª—é—á OpenRouter –Ω–µ –Ω–∞–π–¥–µ–Ω")
    if IN_COLAB:
        print("   –î–æ–±–∞–≤—å—Ç–µ –≤ '–°–µ–∫—Ä–µ—Ç—ã' Colab —Å –∏–º–µ–Ω–µ–º OPENROUTER_API_KEY")
    else:
        print("   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è OPENROUTER_API_KEY")

# –ú–æ–¥–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
#DEFAULT_MODEL = 'google/gemini-2.5-flash-lite'
#DEFAULT_MODEL = 'meta-llama/llama-3.3-70b-instruct:free'
DEFAULT_MODEL = 'tngtech/deepseek-r1t2-chimera:free'

# –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–æ–¥–µ–ª–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
AVAILABLE_MODELS = {
    'gemini': 'google/gemini-2.5-flash-lite',
    'deepseek-free': 'tngtech/deepseek-r1t2-chimera:free',
    'llama': 'meta-llama/llama-3.3-70b-instruct:free',
}

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ OpenRouter API
OPENROUTER_CONFIG = {
    'base_url': 'https://openrouter.ai/api/v1',
    'timeout': 60.0,
    'default_headers': {
        'HTTP-Referer': 'http://localhost:3000',
        'X-Title': 'AIMetodolog Colab'
    }
}

# ============================================================================
# 2. –ù–ê–°–¢–†–û–ô–ö–ò –ì–ï–ù–ï–†–ê–¶–ò–ò
# ============================================================================

# –†–µ–∂–∏–º—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
MODES = {
    'full': '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–Ω—è—Ç–∏—è —Ü–µ–ª–∏–∫–æ–º',
    'sections': '–ü–æ —Ä–∞–∑–¥–µ–ª–∞–º 1 —É—Ä–æ–≤–Ω—è',
    'subsections': '–ü–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–∞–º'
}

# –†–µ–∂–∏–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
DEFAULT_GENERATION_MODE = 'full'

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
GENERATION_PARAMS = {
    'temperature': 0.7,
    'max_tokens': 4000,
    'top_p': 0.9,
}

# ============================================================================
# 3. –ù–ê–°–¢–†–û–ô–ö–ò –ü–£–¢–ï–ô –ò –§–ê–ô–õ–û–í
# ============================================================================

# –ë–∞–∑–æ–≤—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if IN_COLAB:
    BASE_DIR = '/content'
else:
    # –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    BASE_DIR = os.path.dirname(os.path.abspath(__file__))

LOG_DIR = os.path.join(BASE_DIR, 'logs')
OUTPUT_DIR = os.path.join(BASE_DIR, 'output')
PROJECT_DIR = os.path.join(BASE_DIR, 'aimetodolog')
PROJECT_ROOT = PROJECT_DIR
PROJECT_NAME = 'aimetodolog'

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è Colab)
if IN_COLAB:
    DRIVE_BASE_PATH = '/content/drive/MyDrive/prog/aimetodolog'
else:
    DRIVE_BASE_PATH = os.path.join(BASE_DIR, 'drive_backup')

VERSION_PREFIX = 'aimetodolog_v'

# ============================================================================
# 4. –ù–ê–°–¢–†–û–ô–ö–ò –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø
# ============================================================================

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–∫—Å—Ç–∞
TEXT_FORMATTING = {
    'line_width': 120,
    'encoding': 'utf-8'
}

# ============================================================================
# 5. –£–¢–ò–õ–ò–¢–ù–´–ï –§–£–ù–ö–¶–ò–ò –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò
# ============================================================================

def setup_environment():
    """–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã."""
    from platform_utils import setup_environment as platform_setup
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ-–Ω–µ–∑–∞–≤–∏—Å–∏–º—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É
    return platform_setup()

def set_api_key(api_key):
    """–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç API –∫–ª—é—á –≤—Ä—É—á–Ω—É—é."""
    global OPENROUTER_API_KEY
    OPENROUTER_API_KEY = api_key
    os.environ['OPENROUTER_API_KEY'] = api_key
    print(f"‚úÖ API –∫–ª—é—á —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤—Ä—É—á–Ω—É—é ({len(api_key)} —Å–∏–º–≤–æ–ª–æ–≤)")

def get_model_name(model_alias=None):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω–æ–µ –∏–º—è –º–æ–¥–µ–ª–∏ –ø–æ –∞–ª–∏–∞—Å—É."""
    if model_alias is None:
        return DEFAULT_MODEL
    return AVAILABLE_MODELS.get(model_alias, DEFAULT_MODEL)

def print_config_summary():
    """–í—ã–≤–æ–¥–∏—Ç —Å–≤–æ–¥–∫—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏."""
    print("\n" + "=" * 60)
    print("–°–í–û–î–ö–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò –ü–†–û–ï–ö–¢–ê")
    print("=" * 60)
    print(f"–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞: {PROJECT_NAME}")
    print(f"–ú–æ–¥–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: {DEFAULT_MODEL}")
    print(f"–†–µ–∂–∏–º –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {DEFAULT_GENERATION_MODE}")
    print(f"API –∫–ª—é—á: {'‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' if OPENROUTER_API_KEY else '‚ùå –ù–ï –£–°–¢–ê–ù–û–í–õ–ï–ù'}")
    print(f"–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞: {PROJECT_DIR}")
    print(f"–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ª–æ–≥–æ–≤: {LOG_DIR}")
    print(f"–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –≤—ã–≤–æ–¥–∞: {OUTPUT_DIR}")
    print("=" * 60)

# ============================================================================
# 6. –î–ï–ú–û-–†–ï–ñ–ò–ú–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø
# ============================================================================

# –î–µ–º–æ-—Ä–µ–∂–∏–º—ã –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –≤—Ä—É—á–Ω—É—é —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º

# –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ LLM
DEMO_LOCAL = False  # TRUE/FALSE (–≤–º–µ—Å—Ç–æ –æ—Ç–≤–µ—Ç–∞ LLM –≤—ã–≤–æ–¥–∏—Ç—Å—è –∑–∞—Ä–∞–Ω–µ–µ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω)

# –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ–∂–∏–º –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä—É—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∫–æ–Ω—Ç—É—Ä–Ω–æ–π –º–æ–¥–µ–ª–∏ LLM
DEMO_LOCAL_LLM = False  # TRUE/FALSE (–∑–∞–ø—Ä–æ—Å –∫ –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä—É—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∫–æ–Ω—Ç—É—Ä–Ω–æ–π –º–æ–¥–µ–ª–∏ LLM)

# –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ –±–æ–ª—å—à–æ–π –º–æ–¥–µ–ª–∏ LLM, –Ω–æ —Å –∑–∞–ø—Ä–æ—Å–æ–º-–∑–∞–≥–ª—É—à–∫–æ–π
DEMO_BIG_LLM = False  # TRUE/FALSE (–ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç—Ä–∞—Ñ–∏–∫–∞)

# –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ –±–æ–ª—å—à–æ–π –º–æ–¥–µ–ª–∏ LLM —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
DEMO_BIG_LLM_REAL = False  # TRUE/FALSE (—Ä–µ–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö)

# ============================================================================
# 7. –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –ù–ê–°–¢–†–û–ô–ö–ê –ü–†–ò –ò–ú–ü–û–†–¢–ï
# ============================================================================

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –º–æ–¥—É–ª—è
print(f"\nüîß –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ {PROJECT_NAME}...")
setup_environment()
